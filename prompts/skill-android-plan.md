---
name: android-plan
description: Android機能開発・画面追加・バグ修正の作業計画を作成。API仕様・デザイン仕様・画面一覧を参照し、APIテスト・エラーログ保存・pages.md更新を含む計画を生成する。
argument-hint: [feature-description] or [--id=PLAN_ID feature-description]
allowed-tools: [Read, Write, Edit, Glob, Grep, Bash, AskUserQuestion]
---

# Android Plan Skill

Android機能開発・画面追加・バグ修正などのタスクに対して、段階的な作業計画と指示書を作成する。
コンテキストがクリアされても作業を再開できるよう、進捗・中間データ・完了記録をファイルに永続化する。

## 引数の解析

ユーザー入力: `$ARGUMENTS`

### ID の判定ルール

1. `--id=XXXX` が含まれていれば、それを PLAN_ID として使用
2. ID が省略された場合、タスク内容から簡潔な英語ケバブケース ID を生成する（例: `incoming-history`, `picking-ui-fix`）

## 実行手順

### Step 0: プロジェクト仕様の事前読み込み（必須）

**計画作成前に必ず以下のファイルを読み込む:**

1. `prompts/api.md` — API仕様書（エンドポイント・リクエスト・レスポンス）
2. `prompts/design.md` — デザイン仕様（画面解像度・テーマ・画面構成パターン）
3. `prompts/pages.md` — 画面一覧（ページ番号・ルート・遷移関係）

認証情報が必要な場合は `local.properties` を参照する（gitignore対象、コミットしない）。

### Step 1: 作業ディレクトリの特定

保存先は `prompts/{PLAN_ID}/` とする。

```
prompts/{PLAN_ID}/
├── boot.md          # 作業ID・コンテキスト・再開用情報・進捗・完了記録
├── plan.md          # 段階的作業計画（指示書本体）
├── error.log        # サーバ側エラーのログ（発生時に追記）
└── done/            # 完了したドキュメントの保管先
```

### Step 2: ID の解析と既存ディレクトリの確認

引数から PLAN_ID を取得し、`prompts/{PLAN_ID}/` を確認する:

- **ディレクトリが存在し、`boot.md` に同じ ID が記載されている場合** → 既存の作業として扱う（Step 5 へ）
- **存在しない場合** → 新規作業として作成（Step 3 へ）

### Step 3: 新規作業の計画作成

#### boot.md のフォーマット

`boot.md` はセッション復旧の起点。コンテキストがクリアされても、このファイルだけで作業状況を完全に把握できるようにする。

```markdown
# Android Plan: {PLAN_ID}

- **ID**: {PLAN_ID}
- **作成日**: {YYYY-MM-DD}
- **最終更新**: {YYYY-MM-DD}
- **ステータス**: 進行中
- **ディレクトリ**: prompts/{PLAN_ID}/

## セッション再開手順

コンテキストがクリアされた場合、以下を読んで作業を再開する:

1. このファイルを読む（boot.md）
2. プロジェクト仕様を読む: `prompts/api.md`, `prompts/design.md`, `prompts/pages.md`
3. plan.md を読む（作業計画の全体像）
4. 下記「進捗」テーブルで現在のPhaseを確認
5. 「Phase完了記録」セクションで完了済みPhaseの実績を確認
6. 「作業中コンテキスト」セクションで途中データを確認
7. error.log があればサーバ側エラーの履歴を確認
8. 未完了の最初のPhaseから plan.md の該当セクションを読んで作業再開

## 概要

{タスクの1-2行要約}

## 使用API

| メソッド | エンドポイント | 用途 |
|----------|---------------|------|
| {GET/POST/...} | {/api/...} | {用途} |

## 重要な設計制約

- 画面解像度: 320 x 534, 160dpi
- portrait固定、API Level 33
- テーマ: NoActionBar + Compose TopAppBar
- 画面構成: Scaffold + TopAppBar + FunctionKeyBar
- {追加の制約}

## 対象ファイル

### 新規作成
{新規作成するファイルのリスト}

### 既存変更
{変更するファイルのリスト}

### 参照のみ（変更禁止）
{参照のみのファイルのリスト}

## テストデータ

テストユーザー: `local.properties` の `API_TEST_USER` / `API_TEST_PW` を参照

---

## 進捗

| Phase | 状態 | 更新日 | 備考 |
|-------|------|--------|------|
| P0: ... | 未着手 / 進行中 / 完了 | YYYY-MM-DD | {簡潔なメモ} |
| P1: ... | ... | ... | |

---

## 作業中コンテキスト

> Phase作業中に蓄積される中間データ。セッション再開時に必ず確認。
> 各Phase完了時や重要な中間成果物が出た時に更新する。

### API テスト結果（テスト実施後に記入）
- エンドポイント: (実施後に記入)
- レスポンス: (実施後に記入)

### サーバエラー（発生時に記入）
- 詳細は `error.log` を参照

### Git ブランチ
- 作業ブランチ: {ブランチ名}
- ベースブランチ: {ブランチ名}

---

## Phase完了記録

> 各Phase完了時にここに実績を追記する。
> セッション再開時にここを見れば何が終わっているかわかる。

### P0: {Phase名}
- 完了日: -
- 実績:
  - (完了後に記入)
```

#### plan.md のフォーマット

```markdown
# {タスクタイトル} 作業計画

## 前提

### 参照仕様
- API仕様: `prompts/api.md`
- デザイン仕様: `prompts/design.md`
- 画面一覧: `prompts/pages.md`

### 完了済みの作業・現在の状況
{完了済みの作業、現在の状況}

---

## Phase 一覧

| # | Phase | 概要 | 完了条件 |
|---|-------|------|---------|
| P1 | API テスト | 使用APIの疎通確認 | 全APIの正常レスポンス確認 |
| P2 | ... | ... | ... |
| Pn | pages.md 更新 | 画面一覧の更新 | 新規画面が正しく記載 |

---

## P1: API テスト

### 目的
使用する全APIエンドポイントの疎通確認とレスポンス構造の検証

### テスト手順
1. `local.properties` からテストユーザー情報を取得
2. login APIでトークンを取得
3. 各エンドポイントを順番にテスト
4. レスポンスをboot.mdの作業中コンテキストに記録

### テスト対象API
| メソッド | エンドポイント | 期待結果 |
|----------|---------------|---------|
| {method} | {path} | {期待するレスポンス} |

### エラー記録ルール
- サーバ側エラー（4xx/5xx）が発生した場合:
  - `prompts/{PLAN_ID}/error.log` にタイムスタンプ・エンドポイント・ステータスコード・レスポンスボディを追記
  - boot.md の作業中コンテキストにも概要を記入

### 完了条件
- 全APIが正常レスポンスを返すこと
- エラーが発生した場合は error.log に記録済みであること

---

## P2: {機能実装Phase}

### 目的・問題
{何をするか / 何が起きているか}

### 調査手順
{具体的なコマンドや手順}

### 修正方針
{どう直すか — 設計制約も明記}

### 修正対象ファイル
{ファイルパスと役割}

### 完了条件
{何をもって完了とするか}

---

## Pn: pages.md 更新（新規画面がある場合は必須）

### 目的
新規作成した画面を `prompts/pages.md` に反映する

### 更新内容
1. 画面番号体系テーブルに新規画面を追加
2. 画面構成図を更新
3. 各画面の詳細セクションを追加（ページ番号、ファイル、ルート、ヘッダー、主な機能、UI要素、ファンクションキー、遷移先）
4. 画面遷移フローを更新

### 完了条件
- pages.md に新規画面が正しく記載されていること
- 画面番号が既存と重複していないこと
- 遷移先が正しく記載されていること

---

## 制約（厳守）

- 画面解像度 320x534 / 160dpi / portrait固定 を前提にUI設計
- NoActionBar テーマ + Compose TopAppBar パターンを踏襲
- FunctionKeyBar の配置パターンを踏襲（F1〜F4）
- `local.properties` の認証情報はコミットしない
- サーバ側エラーは `error.log` に記録する
- 新規画面作成時は `pages.md` を必ず更新する
- {追加の制約}

## 全体完了条件

- 全PhaseのAPIテストが成功
- 機能が正常に動作（ビルド成功・画面遷移・データ処理）
- サーバエラーがあれば error.log に記録済み
- 新規画面があれば pages.md が更新済み
```

### Step 4: エラーログのフォーマット

サーバ側エラー発生時に `prompts/{PLAN_ID}/error.log` に以下のフォーマットで追記する:

```
========================================
[{YYYY-MM-DD HH:MM:SS}] {Phase名}
----------------------------------------
Endpoint: {METHOD} {URL}
Status: {HTTP status code}
Request:
{リクエストボディ（あれば）}

Response:
{レスポンスボディ}

原因/対応:
{分析・対応メモ}
========================================
```

### Step 5: 既存作業の更新

既存の `boot.md` と `plan.md` を読み込み:

1. **事前に** `prompts/api.md`, `prompts/design.md`, `prompts/pages.md` を再読み込み
2. 現在の進捗を確認する
3. ユーザーの追加指示に基づいて `plan.md` を更新する
4. 完了したPhaseがあれば:
   - `boot.md` の進捗テーブルを更新（状態・更新日・備考）
   - `boot.md` のPhase完了記録に実績を追記
   - `boot.md` の作業中コンテキストに中間データを記入
5. エラーがあれば `error.log` に追記
6. 新たなPhaseの追加が必要であれば `plan.md` に追記する

### Step 6: ユーザーへの確認

作業計画の作成/更新が完了したら、以下を表示する:

1. ディレクトリパス
2. 作成/更新されたファイル一覧
3. Phase の概要テーブル
4. 使用API一覧
5. 「この計画で作業を開始しますか？」と確認

## Phase完了時の更新ルール（必須）

Phase作業が完了したら、**必ず** `boot.md` を以下の手順で更新する:

1. **進捗テーブル**: 該当Phaseの状態を「完了」、更新日を当日、備考に要約を記入
2. **Phase完了記録**: 完了日・実績（具体的な数値やファイル名）を記入
3. **作業中コンテキスト**: 後続Phaseで必要な中間データ（API結果、ID、ファイルパス等）を記入
4. **最終更新日**: boot.md 冒頭の最終更新日を更新
5. **エラーログ**: サーバエラーがあれば error.log に追記済みか確認

これにより、コンテキストがクリアされても `boot.md` だけで全状況を把握し、作業を再開できる。

## 計画作成のガイドライン

### Phase の分割基準

- **P1 は必ず API テスト**（使用APIの疎通確認から開始）
- 1 Phase = 1つの独立した検証可能な単位
- Phase 間に依存関係がある場合は明記する
- 各 Phase に必ず「完了条件」を定義する
- **新規画面がある場合、最終Phase は pages.md 更新**

### 標準的な Phase 構成

```
P1: API テスト        ← 必須（最初）
P2: データ層実装       ← Repository, ViewModel
P3: UI実装            ← Screen, Components
P4: 結合テスト        ← 画面操作での動作確認
P5: pages.md 更新     ← 新規画面がある場合（最後）
```

### 指示書の品質基準

1. **具体的**: 「調べる」ではなく「このAPIを叩いて結果を確認」
2. **再現可能**: 別のセッションでも同じ手順を踏める
3. **計測可能**: 完了条件が主観ではなく客観的
4. **安全**: 破壊的操作の禁止を明記、認証情報をコミットしない
5. **段階的**: 大きなタスクは小さなPhaseに分割

### 制約の明記

以下のような制約がある場合は必ず「制約」セクションに記載:

- 画面解像度・密度の制限
- デザインパターンの踏襲（TopAppBar, FunctionKeyBar）
- 特定ファイルの変更禁止（参照のみ）
- 認証情報のコミット禁止
- 回帰テストの必須条件

## 参考

過去の作業指示書（`prompts/` 配下）の実例があればそれを参考にする。
初回実行時はユーザーに作業内容をヒアリングしてから計画を作成すること。
